---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TOC from '../../components/TOC.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('posts');
  const sortedEntries = blogEntries.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  return sortedEntries.map(entry => ({
    params: { slug: entry.slug }, 
    props: { entry, allPosts: sortedEntries },
  }));
}

const { entry, allPosts } = Astro.props;
const { Content, headings } = await entry.render();

// 面包屑导航
const breadcrumbs = [
	{ label: '首页', href: '/' },
	{ label: '文章', href: '/blog' },
	{ label: entry.data.title }
];

// 提取标题（只包含h2和h3）
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3).map(h => ({
	text: h.text,
	slug: h.slug,
	level: h.depth
}));

// 找到当前文章的索引
const currentIndex = allPosts.findIndex(post => post.slug === entry.slug);

// 获取上一篇和下一篇文章
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
---

<Layout title={entry.data.title}>
    <main>
        <Breadcrumb crumbs={breadcrumbs} />
        {tocHeadings.length > 0 && <TOC headings={tocHeadings} />}
        <article class="post-content">
            <header>
                <h1>{entry.data.title}</h1>
                <div class="meta">
                    <time datetime={entry.data.pubDate.toISOString()}>
                        {entry.data.pubDate.toLocaleDateString('zh-CN')}
                    </time>
                    <span class="author">by {entry.data.author}</span>
                </div>
                {entry.data.tags && entry.data.tags.length > 0 && (
                    <div class="tags">
                        {entry.data.tags.map((tag) => (
                            <span class="tag">{tag}</span>
                        ))}
                    </div>
                )}
                <div class="share-buttons">
                    <button class="share-btn" id="copyLinkBtn" title="复制链接">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        <span>复制链接</span>
                    </button>
                    <button class="share-btn" id="shareTwitterBtn" title="分享到 Twitter">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        <span>Twitter</span>
                    </button>
                    <button class="share-btn" id="shareWeiboBtn" title="分享到微博">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10.098 20.323c-3.977.391-7.414-1.406-7.672-4.02-.259-2.609 2.759-5.047 6.74-5.441 3.979-.394 7.413 1.404 7.671 4.018.259 2.6-2.759 5.049-6.739 5.443z"/>
                            <path d="M15.146 16.604c-1.525 1.732-4.226 2.254-6.096 1.165-1.857-1.081-2.07-3.363-.477-5.092 1.527-1.732 4.197-2.254 6.063-1.174 1.877 1.088 2.099 3.372.51 5.101zm-1.394-1.635c-.324.376-.925.445-1.344.151-.418-.292-.479-.877-.154-1.253.324-.374.915-.443 1.334-.151.418.291.489.876.164 1.253zm1.037-1.387c-.119.139-.345.166-.507.059-.162-.107-.19-.317-.071-.456.119-.138.341-.165.503-.058.162.108.195.317.075.455zm.568-1.672c-1.852-1.049-4.465-.501-5.848 1.226-1.397 1.745-1.025 4.065.828 5.114 1.895 1.073 4.586.488 5.964-1.302 1.362-1.771.905-4.016-.944-5.038z"/>
                            <path d="M20.75 10.28c0-2.966-2.837-5.37-6.335-5.37-.354 0-.7.027-1.037.076.066-.316.103-.643.103-.98 0-2.277-2.022-4.123-4.517-4.123-2.494 0-4.517 1.846-4.517 4.123 0 .426.069.836.194 1.225C2.688 6.274.75 8.645.75 11.39c0 3.452 3.292 6.25 7.354 6.25.336 0 .666-.022.99-.064-.058.291-.091.592-.091.902 0 2.277 2.022 4.123 4.517 4.123 2.494 0 4.517-1.846 4.517-4.123 0-.426-.069-.836-.194-1.225 2.953-1.243 4.907-3.614 4.907-6.273z"/>
                        </svg>
                        <span>微博</span>
                    </button>
                </div>
            </header>
            <div class="markdown-body">
                <Content />
            </div>
            <footer>
                <a href="/blog" class="back-link">← 返回文章列表</a>
            </footer>
        </article>

        <!-- 上一篇/下一篇导航 -->
        <nav class="post-navigation">
            {prevPost && (
                <a href={`/posts/${prevPost.slug}`} class="nav-link prev">
                    <span class="nav-label">← 上一篇</span>
                    <span class="nav-title">{prevPost.data.title}</span>
                </a>
            )}
            {nextPost && (
                <a href={`/posts/${nextPost.slug}`} class="nav-link next">
                    <span class="nav-label">下一篇 →</span>
                    <span class="nav-title">{nextPost.data.title}</span>
                </a>
            )}
        </nav>
    </main>
</Layout>

<style>
    main {
        margin: auto;
        padding: 2rem 1rem;
        max-width: 800px;
    }
    
    header {
        text-align: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding-bottom: 1.5rem;
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 100;
        transition: all 0.3s ease;
        transform: translateY(0);
        opacity: 1;
        overflow: hidden;
        max-height: 500px;
    }

    header.hidden {
        transform: translateY(-100%);
        opacity: 0;
        max-height: 0;
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
        pointer-events: none;
    }

    html[data-theme='dark'] header {
        background: rgba(30, 31, 35, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }
    
    h1 {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        color: var(--c-text);
        line-height: 1.2;
    }
    
    .meta {
        color: var(--c-text-light);
        font-size: 0.95rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        align-items: center;
    }

    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .tag {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        background: rgba(56, 182, 255, 0.1);
        color: var(--c-primary);
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
    }

    html[data-theme='dark'] .tag {
        background: rgba(56, 182, 255, 0.15);
        color: var(--c-primary-light);
    }

    /* 分享按钮 */
    .share-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid var(--c-card-border);
        border-radius: 8px;
        color: var(--c-text);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    html[data-theme='dark'] .share-btn {
        background: rgba(30, 31, 35, 0.3);
        border-color: var(--c-card-border);
    }

    .share-btn:hover {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    html[data-theme='dark'] .share-btn:hover {
        background: rgba(40, 42, 46, 0.5);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .share-btn svg {
        flex-shrink: 0;
    }

    .share-btn:active {
        transform: translateY(0);
    }
    
    .back-link {
        display: inline-block;
        margin-top: 3rem;
        color: var(--c-text-light);
        text-decoration: none;
        transition: color 0.2s;
    }
    
    .back-link:hover {
        color: var(--c-brand);
    }

    /* 上一篇/下一篇导航 */
    .post-navigation {
        display: flex;
        justify-content: space-between;
        gap: 2rem;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    .nav-link {
        flex: 1;
        padding: 1.5rem;
        background: var(--c-card-bg);
        backdrop-filter: blur(12px) saturate(180%);
        -webkit-backdrop-filter: blur(12px) saturate(180%);
        border: 1px solid var(--c-card-border);
        border-radius: var(--radius-card);
        text-decoration: none;
        color: var(--c-text);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .nav-link:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border-color: rgba(255, 255, 255, 0.5);
    }

    html[data-theme='dark'] .nav-link {
        background: var(--c-card-bg);
        border-color: var(--c-card-border);
    }

    html[data-theme='dark'] .nav-link:hover {
        background: rgba(40, 42, 46, 0.6);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border-color: rgba(255, 255, 255, 0.15);
    }

    .nav-label {
        font-size: 0.85rem;
        color: var(--c-text-light);
        font-weight: 500;
    }

    .nav-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--c-text);
        line-height: 1.4;
    }

    .nav-link:hover .nav-title {
        color: var(--c-brand);
    }

    @media (max-width: 640px) {
        .post-navigation {
            flex-direction: column;
        }
    }

    /* Markdown Styles */
    .markdown-body {
        line-height: 1.8;
        color: var(--c-text);
        font-size: 1.1rem;
    }
    
    .markdown-body :global(h2) {
        font-size: 1.8rem;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        color: var(--c-text);
    }
    
    .markdown-body :global(h3) {
        font-size: 1.4rem;
        margin-top: 2rem;
        margin-bottom: 0.8rem;
        color: var(--c-text);
    }
    
    .markdown-body :global(p) {
        margin-bottom: 1.5rem;
    }
    
    .markdown-body :global(ul), .markdown-body :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 2rem;
    }
    
    .markdown-body :global(li) {
        margin-bottom: 0.5rem;
    }
    
    .markdown-body :global(pre) {
        background: #1e1e1e;
        padding: 1.5rem;
        border-radius: var(--radius-card);
        overflow-x: auto;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    html[data-theme='light'] .markdown-body :global(pre) {
        background: #f6f8fa;
        border-color: rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .markdown-body :global(code) {
        font-family: 'Fira Code', 'JetBrains Mono', Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: 0.9rem;
    }

    .markdown-body :global(:not(pre) > code) {
        background: rgba(56, 182, 255, 0.1);
        color: var(--c-primary);
        padding: 0.2rem 0.4rem;
        border-radius: 0.3rem;
        font-size: 0.9em;
    }

    html[data-theme='dark'] .markdown-body :global(:not(pre) > code) {
        background: rgba(56, 182, 255, 0.15);
        color: var(--c-primary-light);
    }
    
    .markdown-body :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-card);
        margin: 1.5rem 0;
    }
</style>

<script is:inline>
	// 分享功能
	const currentUrl = window.location.href;
	const currentTitle = document.querySelector('h1')?.textContent || '分享文章';

	// 复制链接
	document.getElementById('copyLinkBtn')?.addEventListener('click', async () => {
		try {
			await navigator.clipboard.writeText(currentUrl);
			const btn = document.getElementById('copyLinkBtn');
			const originalText = btn.querySelector('span').textContent;
			btn.querySelector('span').textContent = '已复制!';
			setTimeout(() => {
				btn.querySelector('span').textContent = originalText;
			}, 2000);
		} catch (err) {
			// 降级方案
			const textArea = document.createElement('textarea');
			textArea.value = currentUrl;
			document.body.appendChild(textArea);
			textArea.select();
			document.execCommand('copy');
			document.body.removeChild(textArea);
		}
	});

	// 分享到 Twitter
	document.getElementById('shareTwitterBtn')?.addEventListener('click', () => {
		const text = encodeURIComponent(`${currentTitle} ${currentUrl}`);
		window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
	});

	// 分享到微博
	document.getElementById('shareWeiboBtn')?.addEventListener('click', () => {
		const text = encodeURIComponent(`${currentTitle} ${currentUrl}`);
		window.open(`https://service.weibo.com/share/share.php?url=${currentUrl}&title=${currentTitle}`, '_blank');
	});

	// 标题显示/隐藏逻辑
	document.addEventListener('DOMContentLoaded', () => {
		const header = document.querySelector('header');
		let lastScrollTop = 0;
		let headerHidden = false;

		if (!header) {
			return;
		}

		function handleScroll() {
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			const scrollDirection = scrollTop > lastScrollTop ? 'down' : 'up';

			if (scrollDirection === 'down' || scrollTop > 100) {
				// 向下滚动或滚动距离超过100px时隐藏标题
				if (!headerHidden) {
					header.classList.add('hidden');
					headerHidden = true;
				}
			} else if (scrollDirection === 'up') {
				// 向上滚动时显示标题
				if (headerHidden) {
					header.classList.remove('hidden');
					headerHidden = false;
				}
			}

			lastScrollTop = scrollTop;
		}

		// 监听滚动事件
		window.addEventListener('scroll', handleScroll);

		// 初始化 - 页面加载后立即隐藏标题
		header.classList.add('hidden');
		headerHidden = true;
	});

	// 目录高亮当前章节
	function updateActiveTOC() {
		const tocLinks = document.querySelectorAll('.toc-link');
		const headings = document.querySelectorAll('.markdown-body h2, .markdown-body h3');
		
		let currentHeading = null;
		
		// 找到当前视口中的标题
		for (const heading of headings) {
			const rect = heading.getBoundingClientRect();
			if (rect.top <= 150) {
				currentHeading = heading;
			} else {
				break;
			}
		}
		
		// 更新TOC高亮
		tocLinks.forEach(link => {
			link.classList.remove('active');
			if (currentHeading && link.getAttribute('href') === `#${currentHeading.id}`) {
				link.classList.add('active');
			}
		});
	}

	// 监听滚动事件
	let ticking = false;
	window.addEventListener('scroll', () => {
		if (!ticking) {
			window.requestAnimationFrame(() => {
				updateActiveTOC();
				ticking = false;
			});
			ticking = true;
		}
	});

	// 初始化
	document.addEventListener('DOMContentLoaded', updateActiveTOC);
</script>